name: QSD Editorial QA

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Target URL'
        default: 'https://qsd-seven.vercel.app'

env:
  BASE_URL: ${{ github.event.inputs.base_url || 'https://qsd-seven.vercel.app' }}

jobs:
  editorial-qa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Make scripts executable
        run: chmod +x qa/*.sh qa/lib/*.sh scripts/qa_*.sh

      - name: Run QA
        id: qa
        run: |
          set +e

          echo "═══════════════════════════════════════════"
          echo "QSD Editorial Quality Factory"
          echo "Target: ${BASE_URL}"
          echo "═══════════════════════════════════════════"
          echo ""

          # Run QA and capture output to file (Angelus: files as truth)
          bash qa/run-all.sh 2>&1 | tee tmp/qa_raw_output.log
          QA_EXIT_CODE=${PIPESTATUS[0]}

          echo ""
          echo "QA exit code: $QA_EXIT_CODE"

          # Save exit code for subsequent steps
          echo "exit_code=$QA_EXIT_CODE" >> $GITHUB_OUTPUT

          # Preserve exit code for workflow status
          exit $QA_EXIT_CODE

      - name: Write result files
        if: always()
        run: |
          # Write canonical result files (always runs, even on QA failure)
          bash scripts/qa_write_result.sh \
            "${{ steps.qa.outputs.exit_code }}" \
            "tmp/qa_raw_output.log" \
            "${{ github.sha }}" \
            "${{ github.run_id }}" \
            "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Append to ledger
        if: always()
        run: |
          # Append to ledger (append-only, deterministic, always runs)
          bash scripts/qa_append_ledger.sh tmp/qa_result.json

      - name: Notify Discord on FAIL
        if: failure()
        run: |
          # Notify Discord only on FAIL (non-blocking)
          bash scripts/qa_notify_discord.sh tmp/qa_result.json || echo "⚠ Discord notification failed (non-blocking)"
        env:
          DISCORD_WEBHOOK_QA: ${{ secrets.DISCORD_WEBHOOK_QA }}

      - name: Commit and push ledger
        if: always()
        run: |
          git config user.name "qsd-qa-bot"
          git config user.email "qa@quesedice.local"

          # Check if there are changes to commit
          if git diff --quiet data/ledger/qa_runs.jsonl; then
            echo "No changes to ledger, skipping commit"
            exit 0
          fi

          git add data/ledger/qa_runs.jsonl
          git commit -m "chore: qa ledger [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
