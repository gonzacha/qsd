name: QSD Editorial QA

on:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas
  workflow_dispatch:         # Manual trigger
    inputs:
      base_url:
        description: 'Target URL'
        default: 'https://qsd-seven.vercel.app'

env:
  BASE_URL: ${{ github.event.inputs.base_url || 'https://qsd-seven.vercel.app' }}

jobs:
  editorial-qa:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Make scripts executable
        run: chmod +x qa/*.sh qa/lib/*.sh

      - name: Run Editorial Quality Factory
        id: qa
        run: |
          set +e
          output=$(bash qa/run-all.sh 2>&1)
          exit_code=$?
          echo "$output"
          
          # Save for issue creation
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT

          # Base64-encode output to safely handle backticks, Spanish chars, special symbols
          {
            echo 'qa_output<<EOF'
            echo "$output" | base64 -w 0
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          exit $exit_code

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const output = Buffer.from('${{ steps.qa.outputs.qa_output }}', 'base64').toString();
            const title = `ðŸ”´ QSD QA Failed â€” ${new Date().toISOString().split('T')[0]}`;
            
            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'qa-alert'
            });
            
            const body = `## Editorial Quality Factory Report\n\n` +
              `**Target:** \`${process.env.BASE_URL}\`\n` +
              `**Time:** ${new Date().toISOString()}\n` +
              `**Trigger:** ${context.eventName}\n\n` +
              `\`\`\`\n${output}\n\`\`\`\n\n` +
              `---\n*Auto-generated by QSD QA cron*`;
            
            if (issues.data.length > 0) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['qa-alert']
              });
            }
